{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 6, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 68, "column": 0}, "map": {"version":3,"sources":["file:///Users/georgiiisavich/Desktop/assist_plus/src/lib/db.ts"],"sourcesContent":["import Database from 'better-sqlite3';\n\nconst db = new Database('./main.db', { verbose: console.log });\n\nprocess.on('exit', () => db.close());\n\nexport default db;"],"names":[],"mappings":";;;AAAA;;AAEA,MAAM,KAAK,IAAI,2HAAA,CAAA,UAAQ,CAAC,aAAa;IAAE,SAAS,QAAQ,GAAG;AAAC;AAE5D,QAAQ,EAAE,CAAC,QAAQ,IAAM,GAAG,KAAK;uCAElB","debugId":null}},
    {"offset": {"line": 100, "column": 0}, "map": {"version":3,"sources":["file:///Users/georgiiisavich/Desktop/assist_plus/src/app/api/auth/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\nimport db from 'wxqryy/lib/db'; \nimport { URLSearchParams } from 'url';\nimport { createHmac } from 'crypto';\n\nconst REFERRAL_BONUS = 500; \n\nconsole.log('--- [MODULE LOAD] Initializing Database connection...');\n\ndb.exec(`\n  CREATE TABLE IF NOT EXISTS users (\n    id INTEGER PRIMARY KEY AUTOINCREMENT,\n    tg_id INTEGER NOT NULL UNIQUE,\n    username TEXT,\n    first_name TEXT NOT NULL,\n    last_name TEXT,\n    referred_by_id INTEGER,\n    balance_crystals INTEGER NOT NULL DEFAULT 400,\n    last_tap_date TEXT,\n    daily_taps_count INTEGER NOT NULL DEFAULT 0,\n    bio TEXT,\n    awards TEXT,\n    cases_to_open INTEGER NOT NULL DEFAULT 0,\n    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n    last_login_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n    FOREIGN KEY (referred_by_id) REFERENCES users(id)\n  )\n`);\n\ndb.exec(`\n  CREATE TABLE IF NOT EXISTS case_winnings (\n    id INTEGER PRIMARY KEY AUTOINCREMENT,\n    user_id INTEGER NOT NULL,\n    prize_name TEXT NOT NULL,\n    won_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n    FOREIGN KEY (user_id) REFERENCES users(id)\n  )\n`);\n\ndb.exec(`\n  CREATE TABLE IF NOT EXISTS tasks (\n    id INTEGER PRIMARY KEY,\n    task_key TEXT NOT NULL UNIQUE,\n    title TEXT NOT NULL,\n    reward_crystals INTEGER DEFAULT 0\n  )\n`);\n\nconst insertTask = db.prepare(`\n    INSERT OR IGNORE INTO tasks (id, task_key, title, reward_crystals)\n    VALUES (@id, @task_key, @title, @reward_crystals)\n`);\n\ndb.transaction(() => {\n    insertTask.run({ id: 1, task_key: 'subscribe_channel', title: 'Подпишись на Ассист+', reward_crystals: 100 });\n    insertTask.run({ id: 2, task_key: 'vote_poll', title: 'Отдай голос на улучшение канала', reward_crystals: 500 });\n    insertTask.run({ id: 3, task_key: 'invite_friend_assistant', title: 'Пригласи друга, который хочет стать бизнес-ассистентом', reward_crystals: 500 });\n})();\n\nconsole.log('--- [DB SETUP] Tasks seeded successfully (or already exist).');\n\ndb.exec(`\n  CREATE TABLE IF NOT EXISTS user_tasks (\n    user_id INTEGER NOT NULL,\n    task_id INTEGER NOT NULL,\n    status TEXT NOT NULL DEFAULT 'completed',\n    completed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n    PRIMARY KEY (user_id, task_id),\n    FOREIGN KEY(user_id) REFERENCES users(id),\n    FOREIGN KEY(task_id) REFERENCES tasks(id)\n  )\n`);\n\ninterface UserFromDB {\n  id: number;\n  tg_id: number;\n  username: string | null;\n  first_name: string;\n  last_name: string | null;\n  referred_by_id: number | null;\n  balance_crystals: number;\n  last_tap_date: string | null;\n  daily_taps_count: number;\n  cases_to_open: number;\n  created_at: string;\n  last_login_at: string;\n}\n\nfunction validateTelegramHash(initData: string, botToken: string): boolean {\n  try {\n    const params = new URLSearchParams(initData);\n    const hash = params.get('hash');\n    if (!hash) return false;\n    params.delete('hash');\n    const dataCheckArr: string[] = [];\n    const sortedKeys = Array.from(params.keys()).sort();\n    sortedKeys.forEach(key => dataCheckArr.push(`${key}=${params.get(key)}`));\n    const dataCheckString = dataCheckArr.join('\\n');\n    const secretKey = createHmac('sha256', 'WebAppData').update(botToken).digest();\n    const ownHash = createHmac('sha256', secretKey).update(dataCheckString).digest('hex');\n    return ownHash === hash;\n  } catch (error) {\n    console.error(\"Error during hash validation:\", error);\n    return false;\n  }\n}\n\nexport async function POST(req: NextRequest) {\n  console.log(`\\n\\n--- [${new Date().toISOString()}] Received /api/auth request ---`);\n  try {\n    const { initData } = await req.json();\n    console.log('[STEP 1] Received initData:', !!initData);\n\n    if (!initData) {\n      console.error('[FAIL] initData is missing from request body.');\n      return NextResponse.json({ error: 'initData is required' }, { status: 400 });\n    }\n\n    const botToken = process.env.BOT_TOKEN;\n    console.log('[STEP 2] BOT_TOKEN loaded from .env:', !!botToken);\n    if (!botToken) {\n      console.error('CRITICAL: BOT_TOKEN is not defined in environment variables.');\n      return NextResponse.json({ error: 'Server configuration error' }, { status: 500 });\n    }\n\n    const isValid = validateTelegramHash(initData, botToken);\n    console.log('[STEP 3] Hash validation result:', isValid);\n    if (!isValid) {\n      console.warn('[FAIL] Hash validation failed. Request rejected.');\n      return NextResponse.json({ error: 'Invalid data: hash validation failed' }, { status: 403 });\n    }\n\n    console.log('[SUCCESS] Hash validation passed. Processing data...');\n    const params = new URLSearchParams(initData);\n    const userData = JSON.parse(params.get('user') || '{}');\n    const startParam = params.get('start_param');\n\n    if (!userData.id) {\n        console.error('[FAIL] User data or user ID is missing in initData.');\n        return NextResponse.json({ error: 'Invalid user data in initData' }, { status: 400 });\n    }\n    console.log(`[INFO] Processing user with tg_id: ${userData.id}`);\n\n    let finalUser: UserFromDB | undefined;\n    const findUserStmt = db.prepare('SELECT * FROM users WHERE tg_id = ?');\n    const existingUser = findUserStmt.get(userData.id) as UserFromDB | undefined;\n\n    if (existingUser) {\n      console.log(`[DB LOGIC] User ${userData.id} FOUND. Updating...`);\n      const updateUserStmt = db.prepare(`\n        UPDATE users\n        SET username = ?, first_name = ?, last_name = ?, last_login_at = CURRENT_TIMESTAMP\n        WHERE tg_id = ?\n      `);\n      updateUserStmt.run(userData.username, userData.first_name, userData.last_name, userData.id);\n      finalUser = findUserStmt.get(userData.id) as UserFromDB;\n      console.log(`[DB LOGIC] User ${userData.id} UPDATED.`);\n\n    } else {\n      console.log(`[DB LOGIC] User ${userData.id} NOT FOUND. Creating...`);\n      let referredById: number | null = null;\n      \n      if (startParam && startParam.startsWith('ref_')) {\n        const refIdStr = startParam.split('_')[1];\n        const refId = parseInt(refIdStr, 10);\n        \n        if (!isNaN(refId)) {\n          const findReferrerStmt = db.prepare('SELECT id FROM users WHERE id = ?');\n          const referrer = findReferrerStmt.get(refId) as { id: number } | undefined;\n          \n          if (referrer) {\n            referredById = referrer.id;\n        \n            const rewardTransaction = db.transaction(() => {\n                db.prepare('UPDATE users SET balance_crystals = balance_crystals + ? WHERE id = ?').run(REFERRAL_BONUS, referredById);\n                  \n                db.prepare('UPDATE users SET cases_to_open = cases_to_open + 1 WHERE id = ?').run(referredById);\n            });\n\n            try {\n                rewardTransaction();\n                console.log(`[REFERRAL] Rewarded user ${referredById} with ${REFERRAL_BONUS} crystals and 1 case.`);\n            } catch (e) {\n                console.error(`[ERROR] Failed to reward user ${referredById}. Error:`, e);\n            }\n          } else {\n             console.log(`[REFERRAL] Invalid referrer ID '${refIdStr}' in start_param. No referrer found.`);\n          }\n        }\n      }\n\n      const insertUserStmt = db.prepare(`\n        INSERT INTO users (tg_id, username, first_name, last_name, referred_by_id)\n        VALUES (?, ?, ?, ?, ?)\n      `);\n      const result = insertUserStmt.run(userData.id, userData.username, userData.first_name, userData.last_name, referredById);\n      console.log(`[DB LOGIC] New user CREATED with rowid: ${result.lastInsertRowid}`);\n      \n      const findNewUserStmt = db.prepare('SELECT * FROM users WHERE id = ?');\n      finalUser = findNewUserStmt.get(result.lastInsertRowid) as UserFromDB;\n    }\n    \n    console.log('[SUCCESS] Sending final user data to client:', finalUser);\n    return NextResponse.json(finalUser);\n\n  } catch (error) {\n    console.error('--- [FATAL ERROR] API /api/auth crashed inside try...catch block: ---');\n    if (error instanceof Error) {\n        console.error('Error Name:', error.name);\n        console.error('Error Message:', error.message);\n        console.error('Error Stack:', error.stack);\n    } else {\n        console.error('An unknown error occurred:', error);\n    }\n    return NextResponse.json({ error: 'Internal Server Error', details: (error as Error).message }, { status: 500 });\n  }\n}"],"names":[],"mappings":"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","debugId":null}}]
}